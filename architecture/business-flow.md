# 비즈니스 플로우

## 1. 인성검사 (Personality Test) 플로우

### 관리자 측

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 검사 설정                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  검사종류 생성          코드 생성              문항 생성         │
│  (personality_         (personality_          (personality_     │
│   test_types)          codes)                 questions)       │
│       │                    │                       │            │
│       └────────────────────┴───────────────────────┘            │
│                            │                                     │
│                            ▼                                     │
│                     검사지 구성                                   │
│                  (personality_sheets)                            │
│                  - 코드 선택 (JSON)                               │
│                  - 문항 순서 (JSON)                               │
│                  - 정산식 (JSON)                                  │
│                            │                                     │
└────────────────────────────┼─────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. 검사 생성                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  POST /api/personality                                          │
│  ├── 검사명, 기간 설정                                           │
│  ├── 검사지 선택 (personality_sheet_id)                          │
│  ├── 온/오프라인 설정                                            │
│  ├── 등급 기준 점수 (S/A/B/C)                                    │
│  └── 환영 메시지 설정                                            │
│                                                                 │
└────────────────────────────┼─────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. 응시자 등록                                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  POST /api/personality/task/{idx}/applicants/bulk               │
│  ├── Excel 업로드 또는 직접 입력                                  │
│  ├── id/pw 자동 생성                                             │
│  └── 이메일/SMS 발송 (선택)                                      │
│                                                                 │
│  응시자 데이터:                                                   │
│  - name, applicant_number, id, pw                               │
│  - email, phone, field, additional_id                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 응시자 측

```
┌─────────────────────────────────────────────────────────────────┐
│ 4. 응시자 로그인                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  POST /api/applicant/login                                      │
│  Headers: { company: "회사코드" }                                │
│  Body: { id, pw }                                               │
│                                                                 │
│  검증:                                                           │
│  ├── 회사 코드 유효성                                            │
│  ├── 로그인 횟수 (최대 2회)                                      │
│  └── 검사 기간 범위                                              │
│                                                                 │
└────────────────────────────┼─────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. 검사 응시                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Landing Page                                                   │
│  └── 검사 안내, 남은 시간 표시                                   │
│           │                                                     │
│           ▼                                                     │
│  POST /api/applicant/start                                      │
│  └── start_date 기록                                            │
│           │                                                     │
│           ▼                                                     │
│  GET /api/applicant/questions-bulk                              │
│  └── 10개씩 문항 조회                                            │
│           │                                                     │
│           ▼                                                     │
│  POST /api/applicant/answer (임시 저장)                          │
│  └── answer JSON 업데이트                                        │
│           │                                                     │
│           ▼                                                     │
│  POST /api/applicant/end                                        │
│  ├── is_complete = true                                         │
│  ├── end_date 기록                                              │
│  └── 채점 트리거                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 결과 처리

```
┌─────────────────────────────────────────────────────────────────┐
│ 6. 채점 및 보고서                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  자동 채점                                                       │
│  ├── scoring_result JSON 저장                                   │
│  ├── avg_score 계산                                             │
│  └── reliability_score 계산                                     │
│           │                                                     │
│           ▼                                                     │
│  통계 반영                                                       │
│  ├── personality_data_statistics 업데이트                        │
│  └── statistics_reflected = true                                │
│           │                                                     │
│           ▼                                                     │
│  보고서 생성                                                     │
│  ├── PDF 다운로드                                               │
│  ├── Excel 다운로드                                             │
│  └── 외부 API 제공 (report_access_tokens)                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 평판진단 (Reputation) 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 관리자: 평판진단 생성                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  POST /api/reputation/task                                      │
│  ├── 진단명, 기간 설정                                           │
│  ├── 검사지 선택                                                 │
│  ├── 평가자 수 범위 (rater_min, rater_max)                       │
│  └── 메시지 설정 (welcome, info, guide)                         │
│                                                                 │
└────────────────────────────┼─────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. 관리자: 피평가자 등록                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  POST /api/reputation/task/{idx}/applicants                     │
│  └── 피평가자(지원자) 등록                                       │
│                                                                 │
└────────────────────────────┼─────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. 피평가자/관리자: 평가자 등록                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  피평가자 로그인 후:                                             │
│  POST /api/applicant/reputation-rater                           │
│  ├── 평가자 정보 (name, email, company, position)                │
│  ├── 관계 (relationship): 상사/동료/부하 등                      │
│  └── 상호평가 여부 (exchange)                                    │
│                                                                 │
└────────────────────────────┼─────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. 평가자에게 이메일 발송                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  POST /api/applicant/reputation-rater/{idx}/send-email          │
│  ├── 평가 요청 이메일 발송                                       │
│  ├── email_sent_at 기록                                         │
│  └── 5분 내 재발송 제한 (429 에러)                               │
│                                                                 │
└────────────────────────────┼─────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. 평가자: 평가 진행                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  이메일 링크: /rater/{rater_idx}                                 │
│  ├── GET /api/rater/{rater_idx}/info                            │
│  ├── GET /api/rater/{rater_idx}/questions/likert                │
│  ├── GET /api/rater/{rater_idx}/questions/descriptive           │
│  ├── POST /api/rater/{rater_idx}/answers                        │
│  ├── POST /api/rater/{rater_idx}/descriptive-answers            │
│  └── GET /api/rater/{rater_idx}/end                             │
│                                                                 │
│  완료 시:                                                        │
│  ├── is_complete = true                                         │
│  ├── complete_date 기록                                         │
│  └── reputation_data에 점수 저장                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 다면평가 (Multifaceted) 플로우

평판진단과 유사하나, **자기평가(본인 응답)** 기능이 추가됩니다.

```
┌─────────────────────────────────────────────────────────────────┐
│ 추가 단계: 자기평가                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  participant_response 설정에 따라:                               │
│  ├── 본인 응답 활성화 시                                         │
│  │   └── 피평가자도 동일한 문항에 응답                           │
│  └── 타인 평가와 비교 분석 가능                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 4. 상태 관리

### 검사/진단 상태

| 상태 | 조건 | 표시 |
|-----|-----|-----|
| pending | start_date > now | 진행 예정 |
| active | start_date <= now <= end_date, !is_stop | 진행중 |
| completed | end_date < now | 진행 완료 |
| stopped | is_stop = true | 진행 중지 |

### 응시자/평가자 상태

| 상태 | 필드 | 설명 |
|-----|-----|-----|
| 미시작 | start_date = null | 로그인만, 시작 안함 |
| 진행중 | start_date != null, !is_complete | 응시 중 |
| 완료 | is_complete = true | 제출 완료 |

## 5. 데이터 흐름 요약

```
관리자 설정
    │
    ▼
검사/진단 생성 ──────────────────────────┐
    │                                    │
    ▼                                    │
응시자/피평가자 등록                       │
    │                                    │
    ▼                                    │
(평판/다면) 평가자 등록 + 이메일 발송      │
    │                                    │
    ▼                                    ▼
응시/평가 진행 ───────────────────► 답변 저장
    │                              (answer JSON)
    ▼                                    │
완료 ─────────────────────────────────────┤
    │                                    │
    ▼                                    ▼
채점/통계 ◄──────────────────────── scoring_result
    │
    ▼
보고서 생성
```
